<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colegio Bethel</title>

    <!-- Google Fonts Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .bg-custom-green { background-color: #3FB056; }
        .text-custom-green { color: #3FB056; }
        .shadow-custom { box-shadow: 0 10px 15px -3px rgba(59, 176, 86, 0.2), 0 4px 6px -2px rgba(59, 176, 86, 0.1); }

        /* Estilos para el mensaje de notificación (Toast) */
        #notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #10B981; /* Verde esmeralda para éxito */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            z-index: 1000;
            font-weight: 600;
        }

    </style>
</head>
<body class="bg-gray-50">

<!-- Modal de Carga (Loading Spinner) -->
<div id="cargando" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-custom-green"></div>
        <p class="mt-4 text-gray-700">Enviando mensaje...</p>
    </div>
</div>

<!-- Mensaje de Notificación (Toast) -->
<div id="notificacion"></div>

<header class="bg-white shadow-md">
    <div class="max-w-6xl mx-auto flex justify-between items-center py-4 px-4 sm:px-6 lg:px-8">
        <img th:src="@{/logohome.png}" alt="Logo Colegio Bethel" class="h-12">
        <nav>
            <!-- Asegúrate que esta ruta funcione si está autenticado -->
            <a th:href="@{/bandeja}" class="text-gray-600 hover:text-custom-green px-3 py-2 text-sm font-medium">Bandeja</a>
            <a th:href="@{/login}" class="text-gray-600 hover:text-custom-green px-3 py-2 text-sm font-medium">Login</a>
        </nav>
    </div>
</header>

<main class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <div class="text-center">
        <h1 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
            Mensajería Directa Colegio Bethel
        </h1>
        <p class="mt-4 text-lg text-gray-500">
            Contacta a un trabajador de la institución de forma rápida y segura.
        </p>
    </div>

    <div class="mt-10 bg-white p-8 rounded-xl shadow-lg border border-gray-100">
        <form id="mensajeForm" action="/enviarMensaje" method="POST" class="space-y-6">

            <!-- Campo Oculto (Anti-CSRF si fuera necesario, o algún dato de la sesión) -->
            <!-- <input type="hidden" name="_csrf" th:value="${_csrf.token}" /> -->

            <!-- Nombre del Remitente -->
            <div>
                <label for="nombreRemitente" class="block text-sm font-medium text-gray-700">Tu Nombre Completo</label>
                <input type="text" id="nombreRemitente" name="nombreRemitente" required
                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-custom-green focus:border-custom-green sm:text-sm">
            </div>

            <!-- Email Destinatario -->
            <div>
                <label for="emailDestinatario" class="block text-sm font-medium text-gray-700">Destinatario (Email del Trabajador)</label>
                <input type="email" id="emailDestinatario" name="emailDestinatario" required
                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-custom-green focus:border-custom-green sm:text-sm">
            </div>

            <!-- Nombre del Trabajador (Si se requiere para el registro en DB) -->
            <div>
                <label for="nombreTrabajador" class="block text-sm font-medium text-gray-700">Nombre del Trabajador (Opcional para registro)</label>
                <input type="text" id="nombreTrabajador" name="nombreTrabajador"
                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-custom-green focus:border-custom-green sm:text-sm">
            </div>

            <!-- Asunto -->
            <div>
                <label for="asunto" class="block text-sm font-medium text-gray-700">Asunto</label>
                <input type="text" id="asunto" name="asunto" required
                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-custom-green focus:border-custom-green sm:text-sm">
            </div>

            <!-- Mensaje -->
            <div>
                <label for="mensaje" class="block text-sm font-medium text-gray-700">Mensaje</label>
                <textarea id="mensaje" name="mensaje" rows="4" required
                          class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-custom-green focus:border-custom-green sm:text-sm"></textarea>
            </div>

            <!-- Botón de Envío -->
            <div>
                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-custom text-base font-medium text-white bg-custom-green hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-custom-green transition duration-150 ease-in-out">
                    Enviar Mensaje
                </button>
            </div>
        </form>
    </div>
</main>

<script>
    document.getElementById('mensajeForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Detiene el envío normal del formulario

        const form = e.target;
        const formData = new FormData(form);
        const cargando = document.getElementById('cargando');
        const notificacion = document.getElementById('notificacion');

        cargando.style.display = "flex"; // Muestra el modal de carga

        fetch(form.action, {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            cargando.style.display = "none"; // Oculta la carga

            // *** CAMBIO CRUCIAL ***
            // Ya no revisamos el texto de la respuesta. Solo revisamos el estado HTTP.
            if (!response.ok) {
                // Si el estado HTTP no es 200 (OK), es un fallo real.
                // Aquí mostramos el error de red/servidor (que antes era un alert)
                throw new Error('Fallo al enviar mensaje: ' + response.statusText);
            }

            // Si la respuesta es 200 (OK), el proceso continúa al .then() de éxito.
            // Es importante consumir la respuesta aunque no la usemos.
            return response.text();
        })
        .then(result => {
            // ÉXITO: El servidor devolvió 200 OK.

            // 1. Mostrar notificación de éxito
            mostrarNotificacion("Mensaje enviado correctamente.", '#10B981'); // Verde

            // 2. Limpiar el formulario
            form.reset();
        })
        .catch(error => {
            // ERROR: Fallo de red o el servidor devolvió un código de error (4xx o 5xx)
            console.error("Error de envío:", error);

            // 1. Mostrar notificación de error
            mostrarNotificacion("Error al enviar mensaje. Intente de nuevo.", '#EF4444'); // Rojo

            // Nota: El formulario NO se limpia si hay un error
        });
    });


    /**
     * Función para mostrar la notificación tipo "Toast".
     * @param {string} mensaje - El texto a mostrar.
     * @param {string} color - El color de fondo (por ejemplo, '#10B981').
     */
    function mostrarNotificacion(mensaje, color) {
        const notificacion = document.getElementById('notificacion');

        // Si ya hay una notificación visible, la eliminamos primero
        if (notificacion.timeoutId) {
            clearTimeout(notificacion.timeoutId);
            notificacion.style.opacity = '0';
            notificacion.style.transform = 'translateY(-10px)';
        }

        notificacion.textContent = mensaje;
        notificacion.style.backgroundColor = color;

        // Animación de entrada
        setTimeout(() => {
            notificacion.style.opacity = '1';
            notificacion.style.transform = 'translateY(0)';
        }, 50);

        // Animación de salida después de 3 segundos
        notificacion.timeoutId = setTimeout(() => {
            notificacion.style.opacity = '0';
            notificacion.style.transform = 'translateY(-10px)';
        }, 3000);
    }

</script>
</body>
</html>
